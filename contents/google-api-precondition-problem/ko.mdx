import ImageWithCaption from "../../app/components/ImageWithCaption";

export const metadata = {
  title: "Google API '400 Precondition check failed' ì˜¤ë¥˜ í•´ê²°ë²•",
  description:
    "ë„ë©”ì¸ ì „ì²´ ìœ„ì„ì„ ì„¤ì •í•œ ì„œë¹„ìŠ¤ ê³„ì •ìœ¼ë¡œ Gmail API ì‚¬ìš© ì‹œ ë°œìƒí•˜ëŠ” '400 Precondition check failed' ì˜¤ë¥˜ì˜ ì›ì¸ê³¼ í•´ê²° ë°©ë²•ì„ ë¶„ì„í•œë‹¤. JWT ì¸ì¦ ë°©ì‹ì˜ í•„ìš”ì„±ê³¼ êµ¬í˜„ ë°©ë²•ì„ ìƒì„¸íˆ ë‹¤ë£¬ë‹¤.",
  publishedAt: "2025-06-25",
  lastModifiedAt: "2025-06-25",
  timeToRead: 0,
  heroImage:
    "/contents/google-api-precondition-problem/Gemini_Generated_Image_400-bad_request.jpeg",
  tags: [
    "Google API",
    "Gmail API",
    "ì¸ì¦",
    "JWT",
    "OAuth2",
    "ì„œë¹„ìŠ¤ê³„ì •",
    "êµ¬ê¸€í´ë¼ìš°ë“œ",
  ],
};

<ImageWithCaption
  src="/contents/google-api-precondition-problem/Gemini_Generated_Image_400-bad_request.jpeg"
  alt="gemini ìƒì„±, 400 bad request"
/>

## ë¬¸ì œ ìƒí™©

ë„ë©”ì¸ ì „ì²´ ìœ„ì„(Domain-wide Delegation)ì„ ì„¤ì •í•œ ì„œë¹„ìŠ¤ ê³„ì •ì„ í†µí•´ Gmail API, Google Calendar API, Google Contacts API ë“±ì„ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤:

`400 - Bad Request, Precondition check failed.`

ì´ ì˜¤ë¥˜ëŠ” íŠ¹íˆ ë¬¸ì œ í•´ê²°ì„ ì–´ë µê²Œ ë§Œë“œëŠ” íŠ¹ì§•ì´ ìˆë‹¤. **ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦ ìì²´ëŠ” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ ê²ƒì²˜ëŸ¼ ë¡œê·¸ì— ê¸°ë¡ë˜ê¸° ë•Œë¬¸**ì´ë‹¤. ê°œë°œìëŠ” ì¸ì¦ì—ëŠ” ë¬¸ì œê°€ ì—†ë‹¤ê³  íŒë‹¨í•˜ê³  ë‹¤ë¥¸ ì›ì¸ì„ ì°¾ê²Œ ë˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì¸ì¦ ë°©ì‹ ìì²´ì— ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°ê°€ ëŒ€ë¶€ë¶„ì´ë‹¤.

## ì›ì¸ ë¶„ì„

ì´ ì˜¤ë¥˜ì˜ í•µì‹¬ ì›ì¸ì€ **ë¶€ì ì ˆí•œ ì¸ì¦ ë°©ì‹ ì‚¬ìš©**ì— ìˆë‹¤. GoogleAuth í´ë˜ìŠ¤ ìì²´ëŠ” ì—¬ì „íˆ ì§€ì›ë˜ì§€ë§Œ, Gmail API, Google Calendar API, Google Contacts API ë“± ë¯¼ê°í•œ ë°ì´í„°ì— ì ‘ê·¼í•˜ëŠ” APIë“¤ì„ ì‚¬ìš©í•  ë•ŒëŠ” ë” ê°•í™”ëœ ì¸ì¦ ë°©ì‹ì´ í•„ìš”í•˜ë‹¤. ê¸°ë³¸ì ì¸ GoogleAuth í´ë˜ìŠ¤ë§Œìœ¼ë¡œëŠ” ì´ëŸ¬í•œ APIë“¤ì— ëŒ€í•œ ì¶©ë¶„í•œ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ì—†ë‹¤.

### ë¯¼ê°í•œ APIì—ì„œ ë¶€ì¡±í•œ ì¸ì¦ ë°©ì‹

#### 1. ê¸°ë³¸ GoogleAuth ì‚¬ìš©

```javascript
const { google } = require("googleapis");

async function getAuthClient() {
  try {
    console.log("ğŸ”‘ ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦ ì‹œì‘...");

    // âŒ ë¯¼ê°í•œ APIì—ì„œëŠ” ì´ ë°©ì‹ìœ¼ë¡œ ì¶©ë¶„í•œ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ì—†ìŒ
    const auth = new google.auth.GoogleAuth({
      scopes: [
        "https://www.googleapis.com/auth/gmail.readonly",
        "https://www.googleapis.com/auth/gmail.modify",
        "https://www.googleapis.com/auth/gmail.send",
      ],
    });

    const authClient = await auth.getClient();
    // ì¸ì¦ì€ ì„±ê³µí•˜ì§€ë§Œ API í˜¸ì¶œ ì‹œ Precondition ì˜¤ë¥˜ ë°œìƒ
  }
}
```

#### 2. google-auth-libraryì˜ GoogleAuth í´ë˜ìŠ¤ ì‚¬ìš©

```javascript
const { GoogleAuth } = require("google-auth-library");

// âŒ ë¯¼ê°í•œ APIì—ì„œëŠ” ì´ ë°©ì‹ë„ ë¶€ì¡±í•¨
const auth = new GoogleAuth({
  scopes: [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/gmail.modify",
    "https://www.googleapis.com/auth/gmail.send",
  ],
});
```

## í•´ê²° ë°©ë²•: JWT + OAuth2 ì¸ì¦

Google APIì—ì„œ ìš”êµ¬í•˜ëŠ” ì˜¬ë°”ë¥¸ ì¸ì¦ ë°©ì‹ì€ **JWT(JSON Web Token) + OAuth2** ì¡°í•©ì´ë‹¤. ì´ëŠ” Googleì˜ ë³´ì•ˆ ì •ì±… ê°•í™”ì— ë”°ë¥¸ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­ì´ë‹¤.

### ì˜¬ë°”ë¥¸ êµ¬í˜„ ë°©ë²•

```javascript
const { JWT } = require("google-auth-library");
const fs = require("fs");
const path = require("path");

async function getAuthClient() {
  try {
    console.log("ğŸ”‘ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ì¸ì¦ ì‹œì‘...");

    // í‚¤ íŒŒì¼ ê²½ë¡œ ì„¤ì •
    const keyFilePath = path.join(__dirname, "service-account-key.json");

    // í‚¤ íŒŒì¼ ì½ê¸°
    const keyFileContent = fs.readFileSync(keyFilePath, "utf8");
    const credentials = JSON.parse(keyFileContent);

    console.log("âœ… ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ë¡œë“œ ì„±ê³µ");

    // JWT í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    const jwtClient = new JWT({
      email: credentials.client_email,
      key: credentials.private_key,
      scopes: [
        "https://www.googleapis.com/auth/gmail.readonly",
        "https://www.googleapis.com/auth/gmail.modify",
        "https://www.googleapis.com/auth/gmail.send",
      ],
    });

    console.log("âœ… JWT í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ");
    console.log("ğŸ” ì‚¬ìš©ëœ ì„œë¹„ìŠ¤ ê³„ì •:", credentials.client_email);
    console.log("ğŸ”— ì¸ì¦ ìœ í˜•: JWT (í‚¤ íŒŒì¼ ì‚¬ìš©)");

    // â­ í•µì‹¬: JWT í† í° ì¸ì¦ (OAuth2 ê·œê²©ì— ë”°ë¥¸ access_token íšë“)
    await jwtClient.authorize();
    console.log("âœ… JWT í† í° ì¸ì¦ ì™„ë£Œ");

    return jwtClient;
  } catch (error) {
    console.error("âŒ ì¸ì¦ ì‹¤íŒ¨:", error.message);
    throw error;
  }
}
```

### í•µì‹¬ í¬ì¸íŠ¸

1. **JWT í´ë˜ìŠ¤ ì‚¬ìš©**: `google.auth.GoogleAuth` ëŒ€ì‹  `JWT` í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì‚¬ìš©í•œë‹¤.
2. **ëª…ì‹œì  authorize í˜¸ì¶œ**: `jwtClient.authorize()`ë¥¼ ë°˜ë“œì‹œ í˜¸ì¶œí•˜ì—¬ OAuth2 access tokenì„ íšë“í•œë‹¤.
3. **ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼**: í™˜ê²½ ë³€ìˆ˜ë‚˜ ê¸°ë³¸ ì¸ì¦ë³´ë‹¤ëŠ” ëª…ì‹œì ì¸ í‚¤ íŒŒì¼ ì‚¬ìš©ì„ ê¶Œì¥í•œë‹¤.

## ê¸°ìˆ ì  ë°°ê²½

ì´ëŸ¬í•œ ë³€í™”ëŠ” Googleì˜ **Zero Trust ë³´ì•ˆ ëª¨ë¸** ë„ì…ê³¼ ê´€ë ¨ì´ ìˆë‹¤. JWT + OAuth2 ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆ ì´ì ì„ ì œê³µí•œë‹¤:

- **í† í° ê¸°ë°˜ ì¸ì¦**: ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ë³´ë‹¤ í™•ì¥ì„±ê³¼ ë³´ì•ˆì„±ì´ ìš°ìˆ˜í•˜ë‹¤
- **ëª…ì‹œì  ê¶Œí•œ ë¶€ì—¬**: ê° ìš”ì²­ë§ˆë‹¤ ëª…í™•í•œ ê¶Œí•œ ê²€ì¦ì´ ì´ë£¨ì–´ì§„ë‹¤
- **ì‹œê°„ ì œí•œ**: í† í°ì— ë§Œë£Œ ì‹œê°„ì´ ì„¤ì •ë˜ì–´ ë³´ì•ˆ ìœ„í—˜ì„ ìµœì†Œí™”í•œë‹¤

## ë§ˆë¬´ë¦¬

Google APIì˜ '400 Precondition check failed' ì˜¤ë¥˜ëŠ” ëŒ€ë¶€ë¶„ ì¸ì¦ ë°©ì‹ ë¬¸ì œë¡œ ë°œìƒí•œë‹¤. ê¸°ì¡´ì˜ GoogleAuth í´ë˜ìŠ¤ ëŒ€ì‹  JWT + OAuth2 ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. ì´ëŠ” Googleì˜ ë³´ì•ˆ ì •ì±… ê°•í™”ì— ë”°ë¥¸ í•„ìˆ˜ ìš”êµ¬ì‚¬í•­ì´ë¯€ë¡œ, ëª¨ë“  Google API í”„ë¡œì íŠ¸ì—ì„œ ì´ ì¸ì¦ ë°©ì‹ì„ í‘œì¤€ìœ¼ë¡œ ì±„íƒí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

## ì°¸ê³  ìë£Œ

- [Google Auth Library for Node.js](https://cloud.google.com/nodejs/docs/reference/google-auth-library/latest)
- [Service Account Authorization](https://developers.google.com/identity/protocols/oauth2/service-account?hl=ko#delegatingauthority)
- [GitHub Issue #2322](https://github.com/googleapis/google-api-nodejs-client/issues/2322)
- [Google Workspace Admin Help](https://support.google.com/a/answer/14114704?sjid=1342509444799458782-NC)
